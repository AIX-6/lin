<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1, user-scalable=no" />
  <title id="pageTitle">ç¥ç§˜ç«‹å†¬ç¤¼ç‰©â„ï¸</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* ä¿®å¤ï¼šæ·»åŠ å¿…è¦çš„åŠ¨ç”»å’Œå¤‡ç”¨æ’­æ”¾æŒ‰é’®æ ·å¼ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.05); }
    }
    
    .manual-play-btn {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 28px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      font-weight: bold;
      z-index: 10000;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      animation: fadeIn 0.5s ease-out, pulse 2s infinite;
      -webkit-tap-highlight-color: transparent;
    }
    
    .manual-play-btn:active {
      transform: translateX(-50%) scale(0.95);
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }
    
    /* ç¡®ä¿æ¨¡æ€æ¡†åœ¨ iOS ä¸Šå±…ä¸­æ­£å¸¸ */
    .modal-backdrop {
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- åˆå§‹å¼¹çª— -->
    <div class="modal-backdrop" id="start-backdrop">
      <div class="modal">
        <div class="titlebar">
          <span id="festIcon">â„ï¸</span>
          <span id="festTitle">ç«‹å†¬å¿«ä¹</span>
        </div>
        <div class="content">æ‚¨æœ‰ä¸€ä»½<span id="giftWord">ç«‹å†¬</span>ç¤¼ç‰©ï¼Œç¡®å®šè¦æ‰“å¼€å—ï¼Ÿ</div>
        <div class="actions">
          <button class="btn primary" id="confirm-btn">ç¡®å®š</button>
        </div>
      </div>
    </div>
    <div id="popup-layer"></div>
  </div>

  <!-- ä¿®å¤ï¼šæ·»åŠ  playsinline å’Œ webkit-playsinline å±æ€§ï¼ˆiOS å¿…éœ€ï¼‰ -->
  <audio id="bgMusic" 
         preload="auto" 
         loop 
         playsinline 
         webkit-playsinline 
         x5-playsinline 
         style="display:none;"></audio>

  <script>
  (() => {
    const GF_BDAY = '12-15'; // å¥¹ç”Ÿæ—¥

    /* ---------- ä¸€æ¬¡æ€§èŠ‚æ—¥ï¼ˆåªå½“å¤©ï¼‰ ---------- */
    const ONE_DAY = {
      '02-14': ['ğŸ’˜','æƒ…äººèŠ‚å¿«ä¹'],
      '05-20': ['ğŸ’','520å¿«ä¹'],
      '07-07': ['ğŸŒŒ','ä¸ƒå¤•å¿«ä¹'],
      '10-31': ['ğŸƒ','ä¸‡åœ£èŠ‚å¿«ä¹'],
      '12-24': ['ğŸ…','å¹³å®‰å¤œå¿«ä¹'],
      '12-25': ['ğŸ„','åœ£è¯èŠ‚å¿«ä¹'],
      '01-01': ['ğŸ†','å…ƒæ—¦å¿«ä¹'],
      '02-26': ['ğŸ®','å…ƒå®µèŠ‚å¿«ä¹']   // 2026 å¹´
    };

    /* ---------- èŠ‚æ°”ï¼ˆå›ºå®š 3 å¤©ï¼‰ ---------- */
    const SOLAR_TERMS = {
      '02-04': ['ğŸŒ±','ç«‹æ˜¥å¿«ä¹'],
      '03-20': ['ğŸŒ¸','æ˜¥åˆ†å¿«ä¹'],
      '05-05': ['ğŸŒ¿','ç«‹å¤å¿«ä¹'],
      '06-21': ['â˜€ï¸','å¤è‡³å¿«ä¹'],
      '08-07': ['ğŸŒ¾','ç«‹ç§‹å¿«ä¹'],
      '09-23': ['ğŸ‚','ç§‹åˆ†å¿«ä¹'],
      '11-07': ['ğŸ§Š','ç«‹å†¬å¿«ä¹'],   // 2026-11-07 å†°æ™¶ç‰ˆ
      '12-21': ['â„ï¸','å†¬è‡³å¿«ä¹']
    };

    /* ---------- é•¿å‡ï¼ˆå…¨éƒ¨ 3 å¤©ï¼Œå·²é¿å†²çªï¼‰ ---------- */
    const CUSTOM_FEST = {
      // æ˜¥èŠ‚ 8 å¤©ï¼ˆ2026-02-17 é™¤å¤•â†’02-24 åˆä¸ƒï¼‰
      '02-17': ['ğŸ§§','æ˜¥èŠ‚å¿«ä¹'],'02-18': ['ğŸ§§','æ˜¥èŠ‚å¿«ä¹'],'02-19': ['ğŸ§§','æ˜¥èŠ‚å¿«ä¹'],
      '02-20': ['ğŸ§§','æ˜¥èŠ‚å¿«ä¹'],'02-21': ['ğŸ§§','æ˜¥èŠ‚å¿«ä¹'],'02-22': ['ğŸ§§','æ˜¥èŠ‚å¿«ä¹'],
      '02-23': ['ğŸ§§','æ˜¥èŠ‚å¿«ä¹'],'02-24': ['ğŸ§§','æ˜¥èŠ‚å¿«ä¹'],

      // åŠ³åŠ¨èŠ‚ 3 å¤©ï¼ˆ2026-05-01â†’05-03ï¼‰â€”â€”ä¸ç«‹å¤ 5-5~5-7 é”™å¼€
      '05-01': ['ğŸ› ï¸','åŠ³åŠ¨èŠ‚å¿«ä¹'],'05-02': ['ğŸ› ï¸','åŠ³åŠ¨èŠ‚å¿«ä¹'],'05-03': ['ğŸ› ï¸','åŠ³åŠ¨èŠ‚å¿«ä¹'],

      // ç«¯åˆèŠ‚ 3 å¤©ï¼ˆ2026-06-19â†’06-21ï¼‰
      '06-19': ['ğŸ','ç«¯åˆèŠ‚å¿«ä¹'],'06-20': ['ğŸ','ç«¯åˆèŠ‚å¿«ä¹'],'06-21': ['ğŸ','ç«¯åˆèŠ‚å¿«ä¹'],

      // ä¸­ç§‹èŠ‚ 3 å¤©ï¼ˆ2026-09-25â†’09-27ï¼‰
      '09-25': ['ğŸŒ•','ä¸­ç§‹èŠ‚å¿«ä¹'],'09-26': ['ğŸŒ•','ä¸­ç§‹èŠ‚å¿«ä¹'],'09-27': ['ğŸŒ•','ä¸­ç§‹èŠ‚å¿«ä¹'],

      // å›½åº†èŠ‚ 6 å¤©ï¼ˆ2026-10-01â†’10-06ï¼‰
      '10-01': ['ğŸ‡¨ğŸ‡³','å›½åº†èŠ‚å¿«ä¹'],'10-02': ['ğŸ‡¨ğŸ‡³','å›½åº†èŠ‚å¿«ä¹'],'10-03': ['ğŸ‡¨ğŸ‡³','å›½åº†èŠ‚å¿«ä¹'],
      '10-04': ['ğŸ‡¨ğŸ‡³','å›½åº†èŠ‚å¿«ä¹'],'10-05': ['ğŸ‡¨ğŸ‡³','å›½åº†èŠ‚å¿«ä¹'],'10-06': ['ğŸ‡¨ğŸ‡³','å›½åº†èŠ‚å¿«ä¹']
    };

    const pad = n => String(n).padStart(2,'0');
    const fmt = (m, d) => `${pad(m)}-${pad(d)}`;
    const today = new Date();
    const todayKey = fmt(today.getMonth() + 1, today.getDate());

    const week = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    const dateStr = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥ æ˜ŸæœŸ${week[today.getDay()]}`;

    const DEFAULT = [
      'ğŸ“…',
      dateStr + ' ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒå“¦',
      '2025.11.7.mp3',
      dateStr + ' ç¥ç§˜æƒŠå–œç¤¼ç‰©ğŸ“…',
      'æƒŠå–œ'
    ];

    function festPack() {
      if (todayKey === GF_BDAY) return ['ğŸ‚','å®è´ç”Ÿæ—¥å¿«ä¹','2025.11.7.mp3','ç¥ç§˜ç”Ÿæ—¥æƒŠå–œğŸ‚','ç”Ÿæ—¥'];

      // 1. é•¿å‡ï¼ˆå«åŠ³åŠ¨èŠ‚ç­‰ï¼‰
      if (CUSTOM_FEST[todayKey]) {
        const [icon, title] = CUSTOM_FEST[todayKey];
        return [icon, title, '2025.11.7.mp3', `ç¥ç§˜${title}${icon}`, title.slice(0,2)];
      }

      // 2. èŠ‚æ°”ï¼ˆ3 å¤©ï¼‰
      for (let [k,v] of Object.entries(SOLAR_TERMS)) {
        const base = new Date(today.getFullYear(), Number(k.slice(0,2))-1, Number(k.slice(3)));
        for (let i=0;i<3;i++){
          const cur=new Date(base); cur.setDate(base.getDate()+i);
          if (fmt(cur.getMonth()+1,cur.getDate())===todayKey) return [v[0],v[1],'2025.11.7.mp3',`ç¥ç§˜${v[1]}${v[0]}`,v[1].slice(0,2)];
        }
      }

      // 3. ä¸€æ¬¡æ€§èŠ‚æ—¥
      if (ONE_DAY[todayKey]) {
        const [icon, title] = ONE_DAY[todayKey];
        return [icon, title, '2025.11.7.mp3', `ç¥ç§˜${title}${icon}`, title.slice(0,2)];
      }

      return DEFAULT;
    }

    const [icon,title,bgmFile,pageTitle,giftWord] = festPack();
    document.getElementById('festIcon').textContent  = icon;
    document.getElementById('festTitle').textContent = title;
    document.getElementById('pageTitle').textContent = pageTitle;
    document.getElementById('giftWord').textContent  = giftWord;
    
    // é¢„å…ˆè®¾ç½®éŸ³é¢‘æº
    const audio = document.getElementById('bgMusic');
    audio.src = bgmFile;
    
    // iOS é¢„åŠ è½½ç­–ç•¥ï¼šå…ˆé™éŸ³åŠ è½½
    audio.load();

    const msgs = [
      'ä»Šå¤©æ’ä½ä¸è¿è·ªï¼','è®°å¾—banæ‰ä¸œçš‡~','è®°å¾—èººå¥½ï¼Œä¸è¦æ‰é˜Ÿ~','mvp é¢„å®š','é‡åŒºæˆ‘æ‰¿åŒ…äº†',
      'å…µçº¿åˆ«æ¼æ‰','ç‰›å•Šï¼Œç‰›å•Š','ä¼˜åŠ¿åˆ«ä¸Šå¤´','é€†é£ç¨³ä½','æ—©ç‚¹ç¡ï¼Œåˆ«é€šå®µå¼€é»‘',
      'ä»Šå¤©å–å¤Ÿæ°´äº†å—','åˆé¤æƒ³åƒå•¥','æ™šéœæ‹ç…§äº†å—','æ­Œå•è¯¥æ›´æ–°äº†','å¿«é€’åˆ°äº†è®°å¾—å–',
      'æ˜æ—©åˆ«è¿Ÿåˆ°å“¦','ç©ºè°ƒæ¸©åº¦åˆ«å¤ªä½','æ–°ä¸Šçš„å‰§çœ‹äº†å—','å¥¶èŒ¶ä¸‰åˆ†ç³–åˆšå¥½','æ™šå®‰ï¼Œå¥½æ¢¦'
    ];

    const themes = ['theme-blue','theme-green','theme-purple','theme-orange','theme-pink'];
    const anims = ['anim-bottom','anim-top','anim-left','anim-right'];
    const layer = document.getElementById('popup-layer');
    function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    let count = 0;
    const total = 200;
    const interval = 100;

    function addOne(){
      const {innerWidth:w,innerHeight:h} = window;
      const div = document.createElement('div');
      div.className = `popup ${rand(themes)} ${rand(anims)}`;
      div.innerHTML = `
        <div class="header"><span class="icon">ğŸ’</span><span class="title">æç¤º</span></div>
        <div class="content">${rand(msgs)}</div>
      `;
      div.style.left = Math.random() * Math.max(0, w - 230) + 'px';
      div.style.top  = Math.random() * Math.max(0, h - 100) + 'px';
      layer.appendChild(div);
      count++;
      if (count < total) setTimeout(addOne, interval);
    }

    // ä¿®å¤ï¼šæ”¹è¿›çš„éŸ³é¢‘æ’­æ”¾é€»è¾‘ï¼Œå¤„ç†ç§»åŠ¨ç«¯é™åˆ¶
    document.getElementById('confirm-btn').addEventListener('click', async () => {
      document.getElementById('start-backdrop').style.display = 'none';
      
      try {
        // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²å‡†å¤‡å¥½ï¼ˆé’ˆå¯¹ iOSï¼‰
        if (audio.readyState < 2) { // HAVE_CURRENT_DATA
          await new Promise((resolve, reject) => {
            audio.addEventListener('canplaythrough', resolve, {once: true});
            audio.addEventListener('error', reject, {once: true});
            setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶')), 3000);
          });
        }
        
        // å°è¯•æ’­æ”¾
        await audio.play();
        console.log('ğŸµ éŸ³é¢‘æ’­æ”¾æˆåŠŸ');
        
      } catch (err) {
        console.error('âš ï¸ æ’­æ”¾è¢«é˜»æ­¢:', err);
        
        // æ–¹æ¡ˆ 1ï¼šå°è¯•é™éŸ³æ’­æ”¾ï¼ˆéƒ¨åˆ†æµè§ˆå™¨å…è®¸ï¼‰
        try {
          audio.muted = true;
          await audio.play();
          console.log('ğŸ”‡ é™éŸ³æ’­æ”¾æˆåŠŸï¼Œå°è¯•æ¢å¤éŸ³é‡');
          
          // å»¶è¿Ÿå–æ¶ˆé™éŸ³ï¼Œç»™ç”¨æˆ·æ—¶é—´æ„ŸçŸ¥
          setTimeout(() => {
            audio.muted = false;
          }, 800);
          
        } catch (mutedErr) {
          // æ–¹æ¡ˆ 2ï¼šæ˜¾ç¤ºæ‰‹åŠ¨æ’­æ”¾æŒ‰é’®
          console.log('ğŸ¹ æ˜¾ç¤ºæ‰‹åŠ¨æ’­æ”¾æŒ‰é’®');
          showManualPlayButton();
        }
      }
      
      addOne();
    }, {once: true});

    function showManualPlayButton() {
      // å¦‚æœå·²ç»æœ‰æŒ‰é’®ï¼Œä¸å†æ·»åŠ 
      if (document.querySelector('.manual-play-btn')) return;
      
      const btn = document.createElement('button');
      btn.className = 'manual-play-btn';
      btn.innerHTML = 'ğŸ”Š ç‚¹å‡»æ’­æ”¾æƒŠå–œéŸ³æ•ˆ';
      
      btn.addEventListener('click', async () => {
        try {
          audio.muted = false;
          audio.volume = 1.0;
          await audio.play();
          
          // æ’­æ”¾æˆåŠŸåç§»é™¤æŒ‰é’®
          btn.style.animation = 'fadeIn 0.3s reverse forwards';
          setTimeout(() => btn.remove(), 300);
          
        } catch (e) {
          alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å¼€å¯é™éŸ³æ¨¡å¼');
        }
      });
      
      document.body.appendChild(btn);
      
      // 8ç§’åè‡ªåŠ¨ç§»é™¤æŒ‰é’®
      setTimeout(() => {
        if (btn.parentNode) {
          btn.style.animation = 'fadeIn 0.3s reverse forwards';
          setTimeout(() => btn.remove(), 300);
        }
      }, 8000);
    }
    
    // å…¼å®¹æ€§ï¼šå¤„ç†å¾®ä¿¡å†…ç½®æµè§ˆå™¨ï¼ˆWeChatï¼‰
    if (typeof WeixinJSBridge !== 'undefined') {
      document.addEventListener('WeixinJSBridgeReady', () => {
        console.log('å¾®ä¿¡ç¯å¢ƒå·²å°±ç»ª');
      }, false);
    }
  })();
  </script>
</body>
</html>
